name: Deploy EventHub

on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    build-backend:
        runs-on: self-hosted

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Check for backend changes
              id: backend_changed
              run: |
                  if git diff --name-only HEAD^ HEAD | grep -q '^backend/'; then
                    echo "changed=true" >> $GITHUB_OUTPUT
                  else
                    echo "changed=false" >> $GITHUB_OUTPUT
                  fi

            - name: Set up Docker Buildx
              if: steps.backend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              if: steps.backend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GHCR_TOKEN }}

            - name: Build and push backend image
              if: steps.backend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              working-directory: backend
              run: |
                  docker buildx build \
                    --platform linux/amd64 \
                    -t ghcr.io/mikoajp/eventhub-backend:latest \
                    --push .

            - name: Deploy backend to production
              if: steps.backend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              run: |
                  cd ~/homelab/apps/eventhub
                  docker pull ghcr.io/mikoajp/eventhub-backend:latest
                  docker service update --image ghcr.io/mikoajp/eventhub-backend:latest eventhub_backend

    build-frontend:
        runs-on: self-hosted

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Check for frontend changes
              id: frontend_changed
              run: |
                  if git diff --name-only HEAD^ HEAD | grep -q '^frontend/'; then
                    echo "changed=true" >> $GITHUB_OUTPUT
                  else
                    echo "changed=false" >> $GITHUB_OUTPUT
                  fi

            - name: Set up Docker Buildx
              if: steps.frontend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              if: steps.frontend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GHCR_TOKEN }}

            - name: Build and push frontend image
              if: steps.frontend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              working-directory: frontend
              run: |
                  docker buildx build \
                    --platform linux/amd64 \
                    -t ghcr.io/mikoajp/eventhub-frontend:latest \
                    --push .

            - name: Deploy frontend to production
              if: steps.frontend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              run: |
                  cd ~/homelab/apps/eventhub
                  docker pull ghcr.io/mikoajp/eventhub-frontend:latest
                  docker service update --image ghcr.io/mikoajp/eventhub-frontend:latest eventhub_frontend
