name: Deploy EventHub

on:
    push:
        branches:
            - main
    workflow_dispatch:

env:
    REGISTRY: ghcr.io
    IMAGE_BACKEND: ghcr.io/mikoajp/eventhub-backend
    IMAGE_FRONTEND: ghcr.io/mikoajp/eventhub-frontend

jobs:
    build-and-deploy-backend:
        runs-on: self-hosted

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Check for backend changes
              id: backend_changed
              run: |
                  if git diff --name-only HEAD^ HEAD | grep -q '^backend/'; then
                    echo "changed=true" >> $GITHUB_OUTPUT
                  else
                    echo "changed=false" >> $GITHUB_OUTPUT
                  fi

            - name: Generate backend image tags
              if: steps.backend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              id: backend_tags
              run: |
                  TIMESTAMP=$(date +%Y%m%d-%H%M%S)
                  SHORT_SHA=${GITHUB_SHA::7}
                  echo "timestamp_tag=${{ env.IMAGE_BACKEND }}:${TIMESTAMP}-${SHORT_SHA}" >> $GITHUB_OUTPUT
                  echo "latest_tag=${{ env.IMAGE_BACKEND }}:latest" >> $GITHUB_OUTPUT

            - name: Set up Docker Buildx
              if: steps.backend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              if: steps.backend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GHCR_TOKEN }}

            - name: Build and push backend image
              if: steps.backend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              working-directory: backend
              run: |
                  docker buildx build \
                    --platform linux/amd64 \
                    -t ${{ steps.backend_tags.outputs.timestamp_tag }} \
                    -t ${{ steps.backend_tags.outputs.latest_tag }} \
                    --push .

            - name: Deploy backend to production
              if: steps.backend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              run: |
                  cd ~/homelab/apps/eventhub
                  docker service update \
                    --image ${{ steps.backend_tags.outputs.timestamp_tag }} \
                    --with-registry-auth \
                    eventhub_backend
                  
                  echo "Backend deployed with image: ${{ steps.backend_tags.outputs.timestamp_tag }}"

    build-and-deploy-frontend:
        runs-on: self-hosted

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Check for frontend changes
              id: frontend_changed
              run: |
                  if git diff --name-only HEAD^ HEAD | grep -q '^frontend/'; then
                    echo "changed=true" >> $GITHUB_OUTPUT
                  else
                    echo "changed=false" >> $GITHUB_OUTPUT
                  fi

            - name: Generate frontend image tags
              if: steps.frontend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              id: frontend_tags
              run: |
                  TIMESTAMP=$(date +%Y%m%d-%H%M%S)
                  SHORT_SHA=${GITHUB_SHA::7}
                  echo "timestamp_tag=${{ env.IMAGE_FRONTEND }}:${TIMESTAMP}-${SHORT_SHA}" >> $GITHUB_OUTPUT
                  echo "latest_tag=${{ env.IMAGE_FRONTEND }}:latest" >> $GITHUB_OUTPUT

            - name: Set up Docker Buildx
              if: steps.frontend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              if: steps.frontend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GHCR_TOKEN }}

            - name: Build and push frontend image
              if: steps.frontend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              working-directory: frontend
              run: |
                  docker buildx build \
                    --platform linux/amd64 \
                    -t ${{ steps.frontend_tags.outputs.timestamp_tag }} \
                    -t ${{ steps.frontend_tags.outputs.latest_tag }} \
                    --push .

            - name: Deploy frontend to production
              if: steps.frontend_changed.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
              run: |
                  cd ~/homelab/apps/eventhub
                  docker service update \
                    --image ${{ steps.frontend_tags.outputs.timestamp_tag }} \
                    --with-registry-auth \
                    eventhub_frontend
                  
                  echo "Frontend deployed with image: ${{ steps.frontend_tags.outputs.timestamp_tag }}"
